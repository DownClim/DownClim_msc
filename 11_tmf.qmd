```{r setup}
#| include: false
library(tidyverse)
library(terra)
```

# Tropical Moist Forests {.unnumbered}

Tropical moist forest (TMF) climatic niche distributions were projected at the end of the century (2070-2100) using downscaled CMIP6 and CORDEX projections for scenario 2.6 and 8.5. Specifically, we used the definition from Holdridge 1976 (ref) as areas with a mean annual temperature over 16°C, a total annual precipitation over 1,000 mm/year, and a ratio of potential evapotranspiration over precipitation below 1. Potential evaportanspiration (pet, mm/month) was derived from monthly means, maxmimum and minimum temperatures (tas, tas_min, tas_max, 0C) and surface downward shortwave radiation (rsds, MJ/m2/month) as:

$$
 pet = 0.0023 \times rsds \times (tas + 17.8) \times (tasmax - tasmin)^{0.5}
$$

Surface downward shortwave radiation was derived from CHELSA 2 historical climatologies and assumed constant.

## Forests

```{r preptmf}
#| eval: false
index <- data.frame(
  file = list.files("results/tmf/nc/", full.names = F),
  path = list.files("results/tmf/nc/", full.names = T)
) %>% 
  separate(file, c("country", "project", "domain", "institute", "model", "experiment",
                   "ensemble", "rcm", "downscaling", "base", "aggregation",
                   "period_future", "period_present", "period_hist"), sep = "_", remove = F)
files <- index %>% 
  select(country, project, experiment) %>% 
  unique()
for(r in 1:nrow(files))
  filter(index, 
              country == files$country[r], 
              project == files$project[r], 
              experiment == files$experiment[r])$path %>% 
  lapply(rast, lyrs = "tmf") %>% 
  rast() %>% 
  sum() %>% 
  writeRaster(filename = paste0("outputs/tmf/",
                                files$country[r], "_",
                                files$project[r], "_",
                                files$experiment[r], ".tif"),
              overwrite = T)
# issue with 
# New-Caledonia_CORDEX_AUS-22_CLMcom-HZG_MPI-M-MPI-ESM-LR_rcp26_r1i1p1_CCLM5-0-15_v1_chelsa2_monthly-means_2071-2100_2006-2019_1980-2005_bc.nc:tmf
# New-Caledonia_CORDEX_AUS-22_CLMcom-HZG_MPI-M-MPI-ESM-LR_rcp85_r1i1p1_CCLM5-0-15_v1_chelsa2_monthly-means_2071-2100_2006-2019_1980-2005_bc.nc:tmf
```

<!-- Surprisingly, CORDEX projections systematically predicted reduced TMF climatic distribution for both experiment 2.6 and 8.5 compared to CMIP6, with more forest near the coast and in the west following the east to west rainfall gradient. However, in both CORDEX and CMIP6 and both experiments at least one projection was always predicting TMF in every cell. The difference between the two experiments was also a reduced TMF distribution under higher temperature of 8.5, with more forest near the coast and in the west following the east to west rainfall gradient. -->

```{r tmffg}
#| message: false
#| warning: false
#| fig-cap: "Tropical moist forest ditribution predicted in French Guiana by the end of the century for CMIP6 and CORDEX model with experiment 2.6 and 8.5"
fg <- rast(list.files("outputs/tmf/", pattern = "Guiana", full.names = T))
names(fg) <- c("CMIP6_2.6", "CMIP6_8.5", "CORDEX_2.6", "CORDEX_8.5")
as.data.frame(fg, xy = T, na.rm = F) %>% 
  mutate_at(c("CMIP6_2.6", "CMIP6_8.5", "CORDEX_2.6", "CORDEX_8.5"), 
            ~./max(abs(.), na.rm = T)) %>% 
  gather(projection, tmf, -x, -y) %>% 
  separate(projection, c("project", "experiment"), "_") %>% 
  mutate(project = factor(project, levels = c("CMIP6", "CORDEX", "CMIP6-CORDEX"))) %>% 
  ggplot(aes(x, y, fill = tmf)) +
  geom_raster() +
  coord_equal() +
  facet_grid(experiment ~ project) +
  theme_bw() +
  theme(axis.title = element_blank(), 
        axis.ticks = element_blank(),
        axis.text = element_blank(), 
        panel.border = element_blank(), panel.grid = element_blank(),
        panel.background = element_rect(fill = "black")) +
  scale_fill_gradient2("", low = "#e40400", mid = "white", high = "#48712d", 
                       midpoint = 0, na.value = "black", limits = c(-1, 1))
```

<!-- CORDEX simulations predicted less TMF in the central and south west of Ivory Coast but more near the coast , especially in scenario 2.6. **I need to explore the drivers, determining variables tas, pet, pr to be added. I also need to explore the weird CORDEX patterns in the North.** -->

```{r tmfci}
#| message: false
#| warning: false
#| fig-cap: "Tropical moist forest ditribution predicted in Ivory Coast by the end of the century for CMIP6 and CORDEX model with experiment 2.6 and 8.5"
ci <- rast(list.files("outputs/tmf/", pattern = "Ivoire", full.names = T))
names(ci) <- c("CMIP6_2.6", "CMIP6_8.5", "CORDEX_2.6", "CORDEX_8.5")
as.data.frame(ci, xy = T, na.rm = F) %>% 
  mutate_at(c("CMIP6_2.6", "CMIP6_8.5", "CORDEX_2.6", "CORDEX_8.5"), 
            ~./max(abs(.), na.rm = T)) %>% 
  gather(projection, tmf, -x, -y) %>% 
  separate(projection, c("project", "experiment"), "_") %>% 
  mutate(project = factor(project, levels = c("CMIP6", "CORDEX", "CMIP6-CORDEX"))) %>% 
  ggplot(aes(x, y, fill = tmf)) +
  geom_raster() +
  coord_equal() +
  facet_grid(experiment ~ project) +
  theme_bw() +
  theme(axis.title = element_blank(), 
        axis.ticks = element_blank(),
        axis.text = element_blank(), 
        panel.border = element_blank(), panel.grid = element_blank(),
        panel.background = element_rect(fill = "black")) +
  scale_fill_gradient2("", low = "#e40400", mid = "white", high = "#48712d", 
                       midpoint = 0, na.value = "black", limits = c(-1, 1))
```

<!-- CORDEX and CMIP6 major projected distributions of TMF were in agreement in New Caledonia. Only less models projected TMF in the south east of the Grande Terre in CORDEX while more models projected TMF on the west coast in CORDEX, especially in the central west coast in experiment 8.5. -->

```{r tmfnc}
#| message: false
#| warning: false
#| fig-cap: "Tropical moist forest ditribution predicted in New Caledonia by the end of the century for CMIP6 and CORDEX model with experiment 2.6 and 8.5"
nc <- rast(list.files("outputs/tmf/", pattern = "Caledonia", full.names = T))
names(nc) <- c("CMIP6_2.6", "CMIP6_8.5", "CORDEX_2.6", "CORDEX_8.5")
as.data.frame(nc, xy = T, na.rm = F) %>% 
  mutate_at(c("CMIP6_2.6", "CMIP6_8.5", "CORDEX_2.6", "CORDEX_8.5"), 
            ~./max(abs(.), na.rm = T)) %>% 
  gather(projection, tmf, -x, -y) %>% 
  separate(projection, c("project", "experiment"), "_") %>% 
  mutate(project = factor(project, levels = c("CMIP6", "CORDEX", "CMIP6-CORDEX"))) %>% 
  ggplot(aes(x, -y, fill = tmf)) +
  geom_raster() +
  coord_equal() +
  facet_grid(experiment ~ project) +
  theme_bw() +
  theme(axis.title = element_blank(), 
        axis.ticks = element_blank(),
        axis.text = element_blank(), 
        panel.border = element_blank(), panel.grid = element_blank(),
        panel.background = element_rect(fill = "black")) +
  scale_fill_gradient2("", low = "#e40400", mid = "white", high = "#48712d", 
                       midpoint = 0, na.value = "black", limits = c(-1, 1))
```

```{r fig3}
#| message: false
#| warning: false
#| fig-cap: "Caption."
fg <- rast(list.files("outputs/tmf/", pattern = "Guiana", full.names = T))
names(fg) <- c("CMIP6_2.6", "CMIP6_8.5", "CORDEX_2.6", "CORDEX_8.5")
fg_tab <- as.data.frame(fg, xy = T, na.rm = F) %>% 
  mutate_at(c("CMIP6_2.6", "CMIP6_8.5", "CORDEX_2.6", "CORDEX_8.5"), 
            ~./max(abs(.), na.rm = T)) %>% 
  gather(projection, tmf, -x, -y) %>% 
  separate(projection, c("project", "experiment"), "_") %>% 
  filter(experiment == "2.6") %>% 
  mutate(country = "French Guiana")
ci <- rast(list.files("outputs/tmf/", pattern = "Ivoire", full.names = T))
names(ci) <- c("CMIP6_2.6", "CMIP6_8.5", "CORDEX_2.6", "CORDEX_8.5")
ci_tab <- as.data.frame(ci, xy = T, na.rm = F) %>% 
  mutate_at(c("CMIP6_2.6", "CMIP6_8.5", "CORDEX_2.6", "CORDEX_8.5"), 
            ~./max(abs(.), na.rm = T)) %>% 
  gather(projection, tmf, -x, -y) %>% 
  separate(projection, c("project", "experiment"), "_") %>% 
  filter(experiment == "2.6") %>% 
  mutate(country = "Côte d'Ivoire")
nc <- rast(list.files("outputs/tmf/", pattern = "Caledonia", full.names = T))
names(nc) <- c("CMIP6_2.6", "CMIP6_8.5", "CORDEX_2.6", "CORDEX_8.5")
nc_tab <- as.data.frame(nc, xy = T, na.rm = F) %>% 
  mutate_at(c("CMIP6_2.6", "CMIP6_8.5", "CORDEX_2.6", "CORDEX_8.5"), 
            ~./max(abs(.), na.rm = T)) %>% 
  gather(projection, tmf, -x, -y) %>% 
  separate(projection, c("project", "experiment"), "_") %>% 
  filter(experiment == "2.6") %>% 
  mutate(country = "New Caledonia") %>% 
  mutate(y = -y)
g <- bind_rows(fg_tab, ci_tab, nc_tab) %>% 
  ggplot(aes(x, y, fill = tmf)) +
  geom_raster() +
  facet_wrap(~ project ~ country, scales="free") + 
  theme_bw() +
  scale_fill_gradient2("", low = "#e40400", mid = "white", high = "#48712d", 
                       midpoint = 0, na.value = "black", limits = c(-1, 1)) +
  theme(legend.position = "bottom",
        axis.title = element_blank(), 
        axis.ticks = element_blank(),
        axis.text = element_blank(), 
        panel.border = element_blank(), 
        panel.grid = element_blank(),
        panel.background = element_rect(fill = "black"),
        panel.spacing = unit(0,'lines'),
        aspect.ratio = 1)
ggsave("figures/f03.png", g, dpi = 300, width = 8, height = 7, bg = "white")
g
```

## Temperature

```{r preptas}
#| eval: false
index <- data.frame(
  file = list.files("results/tmf/nc/", full.names = F),
  path = list.files("results/tmf/nc/", full.names = T)
) %>% 
  separate(file, c("country", "project", "domain", "institute", "model", "experiment",
                   "ensemble", "rcm", "downscaling", "base", "aggregation",
                   "period_future", "period_present", "period_hist"), sep = "_", remove = F)
files <- index %>% 
  select(country, project, experiment) %>% 
  unique()
for(r in 1:nrow(files))
  filter(index, 
              country == files$country[r], 
              project == files$project[r], 
              experiment == files$experiment[r])$path %>% 
  lapply(rast, lyrs = "tas") %>% 
  rast() %>% 
  mean() %>% 
  writeRaster(filename = paste0("outputs/tas/",
                                files$country[r], "_",
                                files$project[r], "_",
                                files$experiment[r], ".tif"),
              overwrite = T)
```

```{r tasfg}
#| message: false
#| warning: false
#| fig-cap: "Mean annual temperature predicted in French Guiana by the end of the century for CMIP6 and CORDEX model with experiment 2.6 and 8.5"
fg <- rast(list.files("outputs/tas/", pattern = "Guiana", full.names = T))
names(fg) <- c("CMIP6_2.6", "CMIP6_8.5", "CORDEX_2.6", "CORDEX_8.5")
as.data.frame(fg, xy = T, na.rm = F) %>% 
  gather(projection, tmf, -x, -y) %>% 
  separate(projection, c("project", "experiment"), "_") %>% 
  mutate(project = factor(project, levels = c("CMIP6", "CORDEX", "CMIP6-CORDEX"))) %>% 
  ggplot(aes(x, y, fill = tmf)) +
  geom_raster() +
  coord_equal() +
  facet_grid(experiment ~ project) +
  theme_bw() +
  theme(axis.title = element_blank(), 
        axis.ticks = element_blank(),
        axis.text = element_blank(), 
        panel.border = element_blank(), panel.grid = element_blank(),
        panel.background = element_rect(fill = "black")) +
  scale_fill_gradient2("", low = "#053061", mid = "white", high = "#67001f", 
                       midpoint = 16, na.value = "black") +
  geom_contour(aes(z = tmf), breaks = 16)
```

```{r tasci}
#| message: false
#| warning: false
#| fig-cap: "Mean annual temperature predicted in Ivory Coast by the end of the century for CMIP6 and CORDEX model with experiment 2.6 and 8.5"
ci <- rast(list.files("outputs/tas/", pattern = "Ivoire", full.names = T))
names(ci) <- c("CMIP6_2.6", "CMIP6_8.5", "CORDEX_2.6", "CORDEX_8.5")
as.data.frame(ci, xy = T, na.rm = F) %>% 
  gather(projection, tmf, -x, -y) %>% 
  separate(projection, c("project", "experiment"), "_") %>% 
  mutate(project = factor(project, levels = c("CMIP6", "CORDEX", "CMIP6-CORDEX"))) %>% 
  ggplot(aes(x, y, fill = tmf)) +
  geom_raster() +
  coord_equal() +
  facet_grid(experiment ~ project) +
  theme_bw() +
  theme(axis.title = element_blank(), 
        axis.ticks = element_blank(),
        axis.text = element_blank(), 
        panel.border = element_blank(), panel.grid = element_blank(),
        panel.background = element_rect(fill = "black")) +
  scale_fill_gradient2("", low = "#053061", mid = "white", high = "#67001f", 
                       midpoint = 16, na.value = "black") +
  geom_contour(aes(z = tmf), breaks = 16)
```

```{r tasnc}
#| message: false
#| warning: false
#| fig-cap: "Mean annual temperature predicted in New Caledonia by the end of the century for CMIP6 and CORDEX model with experiment 2.6 and 8.5"
nc <- rast(list.files("outputs/tas/", pattern = "Caledonia", full.names = T))
names(nc) <- c("CMIP6_2.6", "CMIP6_8.5", "CORDEX_2.6", "CORDEX_8.5")
as.data.frame(nc, xy = T, na.rm = F) %>% 
  gather(projection, tmf, -x, -y) %>% 
  separate(projection, c("project", "experiment"), "_") %>% 
  mutate(project = factor(project, levels = c("CMIP6", "CORDEX", "CMIP6-CORDEX"))) %>% 
  ggplot(aes(x, -y, fill = tmf)) +
  geom_raster() +
  coord_equal() +
  facet_grid(experiment ~ project) +
  theme_bw() +
  theme(axis.title = element_blank(), 
        axis.ticks = element_blank(),
        axis.text = element_blank(), 
        panel.border = element_blank(), panel.grid = element_blank(),
        panel.background = element_rect(fill = "black")) +
  scale_fill_gradient2("", low = "#053061", mid = "white", high = "#67001f", 
                       midpoint = 16, na.value = "black") +
  geom_contour(aes(z = tmf), breaks = 16)
```

## Precipitation

```{r preppr}
#| eval: false
index <- data.frame(
  file = list.files("results/tmf/nc/", full.names = F),
  path = list.files("results/tmf/nc/", full.names = T)
) %>% 
  separate(file, c("country", "project", "domain", "institute", "model", "experiment",
                   "ensemble", "rcm", "downscaling", "base", "aggregation",
                   "period_future", "period_present", "period_hist"), sep = "_", remove = F)
files <- index %>% 
  select(country, project, experiment) %>% 
  unique()
for(r in 1:nrow(files))
  filter(index, 
              country == files$country[r], 
              project == files$project[r], 
              experiment == files$experiment[r])$path %>% 
  lapply(rast, lyrs = "pr") %>% 
  rast() %>% 
  mean() %>% 
  writeRaster(filename = paste0("outputs/pr/",
                                files$country[r], "_",
                                files$project[r], "_",
                                files$experiment[r], ".tif"),
              overwrite = T)
```

```{r prfg}
#| message: false
#| warning: false
#| fig-cap: "Annual precipitation predicted in French Guiana by the end of the century for CMIP6 and CORDEX model with experiment 2.6 and 8.5"
fg <- rast(list.files("outputs/pr/", pattern = "Guiana", full.names = T))
names(fg) <- c("CMIP6_2.6", "CMIP6_8.5", "CORDEX_2.6", "CORDEX_8.5")
as.data.frame(fg, xy = T, na.rm = F) %>% 
  gather(projection, tmf, -x, -y) %>% 
  separate(projection, c("project", "experiment"), "_") %>% 
  mutate(project = factor(project, levels = c("CMIP6", "CORDEX", "CMIP6-CORDEX"))) %>% 
  ggplot(aes(x, y, fill = tmf)) +
  geom_raster() +
  coord_equal() +
  facet_grid(experiment ~ project) +
  theme_bw() +
  theme(axis.title = element_blank(), 
        axis.ticks = element_blank(),
        axis.text = element_blank(), 
        panel.border = element_blank(), panel.grid = element_blank(),
        panel.background = element_rect(fill = "black")) +
  scale_fill_gradient2("", low = "#543005", mid = "white", high = "#003c30", 
                       midpoint = 1000, na.value = "black") +
  geom_contour(aes(z = tmf), breaks = 1000)
```

```{r prci}
#| message: false
#| warning: false
#| fig-cap: "Annual precipitation predicted in Ivory Coast by the end of the century for CMIP6 and CORDEX model with experiment 2.6 and 8.5"
ci <- rast(list.files("outputs/pr/", pattern = "Ivoire", full.names = T))
names(ci) <- c("CMIP6_2.6", "CMIP6_8.5", "CORDEX_2.6", "CORDEX_8.5")
as.data.frame(ci, xy = T, na.rm = F) %>% 
  gather(projection, tmf, -x, -y) %>% 
  separate(projection, c("project", "experiment"), "_") %>% 
  mutate(project = factor(project, levels = c("CMIP6", "CORDEX", "CMIP6-CORDEX"))) %>% 
  ggplot(aes(x, y, fill = tmf)) +
  geom_raster() +
  coord_equal() +
  facet_grid(experiment ~ project) +
  theme_bw() +
  theme(axis.title = element_blank(), 
        axis.ticks = element_blank(),
        axis.text = element_blank(), 
        panel.border = element_blank(), panel.grid = element_blank(),
        panel.background = element_rect(fill = "black")) +
  scale_fill_gradient2("", low = "#543005", mid = "white", high = "#003c30", 
                       midpoint = 1000, na.value = "black") +
  geom_contour(aes(z = tmf), breaks = 1000)
```

```{r prnc}
#| message: false
#| warning: false
#| fig-cap: "Annual precipitation predicted in New Caledonia by the end of the century for CMIP6 and CORDEX model with experiment 2.6 and 8.5"
nc <- rast(list.files("outputs/pr/", pattern = "Caledonia", full.names = T))
names(nc) <- c("CMIP6_2.6", "CMIP6_8.5", "CORDEX_2.6", "CORDEX_8.5")
as.data.frame(nc, xy = T, na.rm = F) %>% 
  gather(projection, tmf, -x, -y) %>% 
  separate(projection, c("project", "experiment"), "_") %>% 
  mutate(project = factor(project, levels = c("CMIP6", "CORDEX", "CMIP6-CORDEX"))) %>% 
  ggplot(aes(x, -y, fill = tmf)) +
  geom_raster() +
  coord_equal() +
  facet_grid(experiment ~ project) +
  theme_bw() +
  theme(axis.title = element_blank(), 
        axis.ticks = element_blank(),
        axis.text = element_blank(), 
        panel.border = element_blank(), panel.grid = element_blank(),
        panel.background = element_rect(fill = "black")) +
  scale_fill_gradient2("", low = "#543005", mid = "white", high = "#003c30", 
                       midpoint = 1000, na.value = "black") +
  geom_contour(aes(z = tmf), breaks = 1000)
```

## Water balance

```{r prepwb}
#| eval: false
index <- data.frame(
  file = list.files("results/tmf/nc/", full.names = F),
  path = list.files("results/tmf/nc/", full.names = T)
) %>% 
  separate(file, c("country", "project", "domain", "institute", "model", "experiment",
                   "ensemble", "rcm", "downscaling", "base", "aggregation",
                   "period_future", "period_present", "period_hist"), sep = "_", remove = F)
files <- index %>% 
  select(country, project, experiment) %>% 
  unique()
for(r in 1:nrow(files))
  filter(index, 
              country == files$country[r], 
              project == files$project[r], 
              experiment == files$experiment[r])$path %>% 
  lapply(rast, lyrs = "pet_pr") %>% 
  rast() %>% 
  mean() %>% 
  writeRaster(filename = paste0("outputs/wb/",
                                files$country[r], "_",
                                files$project[r], "_",
                                files$experiment[r], ".tif"),
              overwrite = T)
```

```{r wbfg}
#| message: false
#| warning: false
#| fig-cap: "Annual ratio of potential evapotranspiration over precipitation  ditribution predicted in French Guiana by the end of the century for CMIP6 and CORDEX model with experiment 2.6 and 8.5"
fg <- rast(list.files("outputs/wb/", pattern = "Guiana", full.names = T))
names(fg) <- c("CMIP6_2.6", "CMIP6_8.5", "CORDEX_2.6", "CORDEX_8.5")
as.data.frame(fg, xy = T, na.rm = F) %>% 
  gather(projection, tmf, -x, -y) %>% 
  separate(projection, c("project", "experiment"), "_") %>% 
  mutate(project = factor(project, levels = c("CMIP6", "CORDEX", "CMIP6-CORDEX"))) %>% 
  ggplot(aes(x, y, fill = tmf)) +
  geom_raster() +
  coord_equal() +
  facet_grid(experiment ~ project) +
  theme_bw() +
  theme(axis.title = element_blank(), 
        axis.ticks = element_blank(),
        axis.text = element_blank(), 
        panel.border = element_blank(), panel.grid = element_blank(),
        panel.background = element_rect(fill = "black")) %>% 
  scale_fill_gradient2("", low = "#003c30", mid = "white", high = "#543005", 
                       midpoint = 1, na.value = "black") +
  geom_contour(aes(z = tmf), breaks = 1)
```

```{r wbci}
#| message: false
#| warning: false
#| fig-cap: "Annual ratio of potential evapotranspiration over precipitation  ditribution predicted in Ivory Coast by the end of the century for CMIP6 and CORDEX model with experiment 2.6 and 8.5"
ci <- rast(list.files("outputs/wb/", pattern = "Ivoire", full.names = T))
names(ci) <- c("CMIP6_2.6", "CMIP6_8.5", "CORDEX_2.6", "CORDEX_8.5")
as.data.frame(ci, xy = T, na.rm = F) %>% 
  gather(projection, tmf, -x, -y) %>% 
  separate(projection, c("project", "experiment"), "_") %>% 
  mutate(project = factor(project, levels = c("CMIP6", "CORDEX", "CMIP6-CORDEX"))) %>% 
  ggplot(aes(x, y, fill = tmf)) +
  geom_raster() +
  coord_equal() +
  facet_grid(experiment ~ project) +
  theme_bw() +
  theme(axis.title = element_blank(), 
        axis.ticks = element_blank(),
        axis.text = element_blank(), 
        panel.border = element_blank(), panel.grid = element_blank(),
        panel.background = element_rect(fill = "black")) %>% 
  scale_fill_gradient2("", low = "#003c30", mid = "white", high = "#543005", 
                       midpoint = 1, na.value = "black") +
  geom_contour(aes(z = tmf), breaks = 1)
```

```{r wbnc}
#| message: false
#| warning: false
#| fig-cap: "Annual ratio of potential evapotranspiration over precipitation  ditribution predicted in New Caledonia by the end of the century for CMIP6 and CORDEX model with experiment 2.6 and 8.5"
nc <- rast(list.files("outputs/wb/", pattern = "Caledonia", full.names = T))
names(nc) <- c("CMIP6_2.6", "CMIP6_8.5", "CORDEX_2.6", "CORDEX_8.5")
as.data.frame(nc, xy = T, na.rm = F) %>% 
  gather(projection, tmf, -x, -y) %>% 
  separate(projection, c("project", "experiment"), "_") %>% 
  mutate(project = factor(project, levels = c("CMIP6", "CORDEX", "CMIP6-CORDEX"))) %>% 
  ggplot(aes(x, -y, fill = tmf)) +
  geom_raster() +
  coord_equal() +
  facet_grid(experiment ~ project) +
  theme_bw() +
  theme(axis.title = element_blank(), 
        axis.ticks = element_blank(),
        axis.text = element_blank(), 
        panel.border = element_blank(), panel.grid = element_blank(),
        panel.background = element_rect(fill = "black")) %>% 
  scale_fill_gradient2("", low = "#003c30", mid = "white", high = "#543005", 
                       midpoint = 1, na.value = "black") +
  geom_contour(aes(z = tmf), breaks = 1)
```
